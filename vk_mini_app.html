<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EngageBot - CSGO –ú–∞–≥–∞–∑–∏–Ω</title>
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #fff;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .header h1 {
            font-size: 1.6em;
            margin-bottom: 5px;
            color: #4ecdc4;
        }

        .nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            flex: 1;
            min-width: 120px;
            text-align: center;
        }

        .nav-btn.active {
            background: #4ecdc4;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* –°—Ç–∏–ª–∏ –º–∞–≥–∞–∑–∏–Ω–∞ */
        .shop-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        #searchInput {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
        }

        .category-select, .sort-select {
            min-width: 150px;
        }

        #categorySelect, #sortSelect {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .price-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 170px;
        }

        .price-filter input {
            width: 65px;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
            font-size: 13px;
        }

        .price-filter span {
            color: #ccc;
            font-weight: bold;
        }

        /* –°–µ—Ç–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .item-image {
            width: 100%;
            height: 100px;
            object-fit: contain;
            border-radius: 6px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
        }

        .item-name {
            font-size: 12px;
            margin-bottom: 6px;
            line-height: 1.3;
            height: 28px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .item-price {
            font-size: 14px;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 8px;
        }

        .buy-btn {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: #4ecdc4;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .buy-btn:hover {
            background: #45b8b0;
        }

        /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 13px;
            color: #ccc;
        }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .profile-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            max-width: 100%;
        }

        .balance {
            font-size: 1.8em;
            text-align: center;
            margin: 15px 0;
            color: #4ecdc4;
        }

        .trade-link-input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin: 10px 0;
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #4ecdc4;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading {
            text-align: center;
            padding: 30px;
            color: #ccc;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .items-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .shop-controls {
                flex-direction: column;
            }
            
            .search-box, .category-select, .price-filter, .sort-select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ EngageBot CSGO</h1>
            <p>–ü–æ–∫—É–ø–∞–π—Ç–µ —Å–∫–∏–Ω—ã –∑–∞ –º–æ–Ω–µ—Ç—ã</p>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('shop')">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-btn" onclick="showSection('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <!-- –ú–∞–≥–∞–∑–∏–Ω -->
        <div id="shop" class="section active">
            <div class="shop-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ —Å–∫–∏–Ω–æ–≤..." 
                           oninput="debouncedSearch(this.value)">
                </div>
                <div class="category-select">
                    <select id="categorySelect" onchange="loadCategory(this.value)">
                        <option value="pistols">üî´ –ü–∏—Å—Ç–æ–ª–µ—Ç—ã</option>
                        <option value="rifles">üèπ –í–∏–Ω—Ç–æ–≤–∫–∏</option>
                        <option value="smgs">üî´ –ü–ü</option>
                        <option value="shotguns">üí• –î—Ä–æ–±–æ–≤–∏–∫–∏</option>
                        <option value="knives">üî™ –ù–æ–∂–∏</option>
                        <option value="gloves">üß§ –ü–µ—Ä—á–∞—Ç–∫–∏</option>
                        <option value="cases">üéÅ –ö–µ–π—Å—ã</option>
                        <option value="stickers">üè∑Ô∏è –°—Ç–∏–∫–µ—Ä—ã</option>
                    </select>
                </div>
                <div class="price-filter">
                    <input type="number" id="minPrice" placeholder="0" min="0" max="1000" 
                           onchange="updatePriceFilter()">
                    <span>-</span>
                    <input type="number" id="maxPrice" placeholder="1000" min="0" max="1000" 
                           onchange="updatePriceFilter()">
                </div>
                <div class="sort-select">
                    <select id="sortSelect" onchange="updateSort()">
                        <option value="price_asc">–°–Ω–∞—á–∞–ª–∞ –¥–µ—à–µ–≤—ã–µ</option>
                        <option value="price_desc">–°–Ω–∞—á–∞–ª–∞ –¥–æ—Ä–æ–≥–∏–µ</option>
                        <option value="name_asc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –ê-–Ø</option>
                        <option value="name_desc">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é –Ø-–ê</option>
                    </select>
                </div>
            </div>
            
            <div id="itemsList" class="loading">
                <div>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>
            </div>
            
            <div class="pagination">
                <button id="prevBtn" onclick="prevPage()">‚óÄ –ù–∞–∑–∞–¥</button>
                <span id="pageInfo" class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
                <button id="nextBtn" onclick="nextPage()">–í–ø–µ—Ä–µ–¥ ‚ñ∂</button>
            </div>
        </div>

        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div id="profile" class="section">
            <div class="profile-card">
                <h2>üë§ –í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h2>
                <div class="balance" id="userBalance">0 ‚ÇΩ</div>
                <p>–ë–∞–ª–∞–Ω—Å: <span id="balanceAmount">0</span> –º–æ–Ω–µ—Ç</p>
                
                <div style="margin: 20px 0;">
                    <h3>üîó –¢–æ—Ä–≥–æ–≤–∞—è —Å—Å—ã–ª–∫–∞ Steam</h3>
                    <input type="text" id="tradeLink" class="trade-link-input" 
                           placeholder="https://steamcommunity.com/tradeoffer/new/?partner=...">
                    <button class="save-btn" onclick="saveTradeLink()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VK Bridge –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        let currentUser = { id: null };
        let currentPage = 0;
        let currentCategory = 'pistols';
        let currentSearch = '';
        let currentMinPrice = 0;
        let currentMaxPrice = 1000;
        let currentSort = 'price_asc';
        let hasMore = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è VK Mini App
        async function initVK() {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º VK Bridge
                await vkBridge.send('VKWebAppInit');
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userInfo = await vkBridge.send('VKWebAppGetUserInfo');
                currentUser.id = userInfo.id.toString();
                
                console.log('VK User:', currentUser);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                initFilters();
                loadItems();
                loadUserProfile();
                
            } catch (error) {
                console.error('VK init error:', error);
                // Fallback –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–µ VK
                currentUser.id = "123456789";
                initFilters();
                loadItems();
                loadUserProfile();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function initFilters() {
            document.getElementById('minPrice').value = currentMinPrice;
            document.getElementById('maxPrice').value = currentMaxPrice;
            document.getElementById('sortSelect').value = currentSort;
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            if (sectionName === 'profile') {
                loadUserProfile();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Ü–µ–Ω—ã
        function updatePriceFilter() {
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || 1000;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (minPrice < 0) {
                document.getElementById('minPrice').value = 0;
                currentMinPrice = 0;
            } else {
                currentMinPrice = minPrice;
            }
            
            if (maxPrice > 1000) {
                document.getElementById('maxPrice').value = 1000;
                currentMaxPrice = 1000;
            } else if (maxPrice < currentMinPrice) {
                document.getElementById('maxPrice').value = currentMinPrice;
                currentMaxPrice = currentMinPrice;
            } else {
                currentMaxPrice = maxPrice;
            }
            
            currentPage = 0;
            loadItems();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function updateSort() {
            currentSort = document.getElementById('sortSelect').value;
            currentPage = 0;
            loadItems();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        async function loadCategory(category, page = 0) {
            currentCategory = category;
            currentPage = page;
            currentSearch = '';
            
            document.getElementById('searchInput').value = '';
            await loadItems();
        }

        // –ü–æ–∏—Å–∫ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
        let searchTimeout;
        function debouncedSearch(query) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = query;
                currentPage = 0;
                loadItems();
            }, 500);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        async function loadItems() {
            try {
                const itemsList = document.getElementById('itemsList');
                itemsList.innerHTML = '<div class="loading">üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</div>';
                
                let url;
                if (currentSearch) {
                    url = `http://localhost:8000/api/csmani/search?query=${encodeURIComponent(currentSearch)}&max_price=1000`;
                } else {
                    url = `http://localhost:8000/api/csmani/items?category=${currentCategory}&page=${currentPage}&limit=20&max_price=1000`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.success && data.items && data.items.length > 0) {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                    let filteredItems = data.items.filter(item => 
                        item.price >= currentMinPrice && item.price <= currentMaxPrice
                    );
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
                    filteredItems = sortItems(filteredItems, currentSort);
                    
                    if (filteredItems.length > 0) {
                        itemsList.innerHTML = '<div class="items-grid"></div>';
                        const grid = itemsList.querySelector('.items-grid');
                        
                        filteredItems.forEach(item => {
                            const card = document.createElement('div');
                            card.className = 'item-card';
                            card.innerHTML = `
                                <img src="${item.image}" alt="${item.name}" class="item-image" 
                                     onerror="this.src='https://via.placeholder.com/160x100/2a2a3e/ffffff?text=CSGO'">
                                <div class="item-name">${item.name}</div>
                                <div class="item-price">${item.price.toFixed(2)} ‚ÇΩ</div>
                                <button class="buy-btn" onclick="buyItem('${item.id}', ${item.price})">
                                    üõí –ö—É–ø–∏—Ç—å
                                </button>
                            `;
                            grid.appendChild(card);
                        });
                        
                        updatePagination(data.has_more);
                    } else {
                        itemsList.innerHTML = '<div class="loading">üòî –¢–æ–≤–∞—Ä–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ü–µ–Ω–æ–≤–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                        updatePagination(false);
                    }
                } else {
                    itemsList.innerHTML = '<div class="loading">üòî –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                    updatePagination(false);
                }
            } catch (err) {
                itemsList.innerHTML = '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                console.error('–û—à–∏–±–∫–∞:', err);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function sortItems(items, sortType) {
            switch(sortType) {
                case 'price_asc':
                    return items.sort((a, b) => a.price - b.price);
                case 'price_desc':
                    return items.sort((a, b) => b.price - a.price);
                case 'name_asc':
                    return items.sort((a, b) => a.name.localeCompare(b.name));
                case 'name_desc':
                    return items.sort((a, b) => b.name.localeCompare(a.name));
                default:
                    return items;
            }
        }

        // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        function updatePagination(hasMoreItems) {
            hasMore = hasMoreItems;
            document.getElementById('pageInfo').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage + 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = !hasMore;
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                loadItems();
            }
        }

        function nextPage() {
            if (hasMore) {
                currentPage++;
                loadItems();
            }
        }

        // –ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞
        async function buyItem(itemId, price) {
            if (!currentUser.id) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ VK
                await vkBridge.send('VKWebAppShowNotification', {
                    notification_text: `–ü–æ–∫—É–ø–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –∑–∞ ${price.toFixed(2)} –º–æ–Ω–µ—Ç`
                });
                
                const res = await fetch('http://localhost:8000/api/csmani/buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_id: itemId,
                        price: price,
                        admin_id: 'test_admin',
                        user_id: currentUser.id
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    await vkBridge.send('VKWebAppShowNotification', {
                        notification_text: '‚úÖ –ü—Ä–µ–¥–º–µ—Ç —É—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω!'
                    });
                    loadUserProfile();
                } else {
                    await vkBridge.send('VKWebAppShowNotification', {
                        notification_text: `‚ùå ${data.error}`
                    });
                }
            } catch (err) {
                await vkBridge.send('VKWebAppShowNotification', {
                    notification_text: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ'
                });
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
        async function loadUserProfile() {
            if (!currentUser.id) return;
            
            try {
                const res = await fetch(`http://localhost:8000/api/user/${currentUser.id}`);
                const data = await res.json();
                
                if (data.success) {
                    document.getElementById('userBalance').textContent = data.user.balance + ' ‚ÇΩ';
                    document.getElementById('balanceAmount').textContent = data.user.balance;
                    document.getElementById('tradeLink').value = data.user.trade_link || '';
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', err);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∏
        async function saveTradeLink() {
            const link = document.getElementById('tradeLink').value;
            if (!currentUser.id) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }
            
            if (link) {
                try {
                    const res = await fetch(`http://localhost:8000/api/user/${currentUser.id}/trade-link`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ trade_link: link })
                    });
                    
                    const data = await res.json();
                    
                    if (data.success) {
                        await vkBridge.send('VKWebAppShowNotification', {
                            notification_text: '‚úÖ –°—Å—ã–ª–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!'
                        });
                    } else {
                        await vkBridge.send('VKWebAppShowNotification', {
                            notification_text: '‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'
                        });
                    }
                } catch (err) {
                    await vkBridge.send('VKWebAppShowNotification', {
                        notification_text: '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏'
                    });
                }
            } else {
                await vkBridge.send('VKWebAppShowNotification', {
                    notification_text: '‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤—É—é —Å—Å—ã–ª–∫—É'
                });
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        document.addEventListener('DOMContentLoaded', initVK);
    </script>
</body>
</html>